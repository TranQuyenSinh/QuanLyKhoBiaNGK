@model QuanLyKhoBiaNGK.ViewModels.CreateProductModel

@{
    @* ViewData["Title"] = "Thêm Hàng Hóa"; *@
}

<h1>Thêm sản phẩm mới</h1>


<hr />
<form asp-action="Create">
    <div class="row">
        <div class="col-md-6">
            <div asp-validation-summary="All" class="text-danger"></div>
            <div class="form-group">
                <label asp-for="Name" class="control-label"></label>
                <input asp-for="Name" class="form-control" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Description" class="control-label"></label>
                <input asp-for="Description" class="form-control" />
                <span asp-validation-for="Description" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="InventoryLevel" class="control-label"></label>
                <input asp-for="InventoryLevel" class="form-control" />
                <span asp-validation-for="InventoryLevel" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Inventory" class="control-label"></label>
                <input asp-for="Inventory" class="form-control" />
                <span asp-validation-for="Inventory" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="CategoryId" class="control-label"></label>
                <select asp-for="CategoryId" class="form-control" asp-items="ViewBag.CategoryId"></select>
            </div>
            <div class="form-group mt-3">
                <input type="submit" value="Create" class="btn btn-primary" /> |
                <a class="btn btn-secondary mt-1" asp-action="Index">Trở lại danh sách</a>  
            </div>
        </div>
        <div class="col-md-6">
            <div id="price-container">
                @if (Model == null || Model.Prices == null || Model.Prices.Count == 0)
                {
                    <div class="row">
                        <div class="form-group col">
                            <label class="control-label">Đơn vị tính</label>
                            <input asp-for="@Model.Prices[0].Unit" class="form-control" />
                        </div>
                        <div class="form-group col">
                            <label class="control-label">Quy đổi</label>
                            <input asp-for="@Model.Prices[0].ConversionRate" class="form-control" />
                        </div>
                        <div class="form-group col">
                            <label class="control-label">Giá nhập</label>
                            <input asp-for="@Model.Prices[0].PurchasePrice" class="form-control" />
                        </div>
                        <div class="form-group col">
                            <label class="control-label">Giá bán lẻ</label>
                            <input asp-for="@Model.Prices[0].RetailPrice" class="form-control" />
                        </div>
                        <div class="form-group col">
                            <label class="control-label">Giá bán sỉ</label>
                            <input asp-for="@Model.Prices[0].WholesalePrice" class="form-control" />
                        </div>
                        <div class="form-group col d-flex align-items-center justify-content-center">
                            <button type="button" disabled class="btnRemove btn btn-sm btn-danger w-100">Xóa</button>
                        </div>
                    </div>
                }
                else if (Model.Prices != null && Model.Prices.Count > 0)
                {
                    @for (var i = 0; i < Model.Prices.Count; i++)
                    {
                        <div class="row">
                            <div class="form-group col">
                                <label class="control-label">Đơn vị tính</label>
                                <input asp-for="@Model.Prices[@i].Unit" class="form-control" />
                                <span asp-validation-for="@Model.Prices[@i].Unit" class="text-danger"></span>
                            </div>
                            <div class="form-group col">
                                <label class="control-label">Quy đổi</label>
                                <input asp-for="@Model.Prices[@i].ConversionRate" class="form-control" />
                                <span asp-validation-for="@Model.Prices[@i].ConversionRate" class="text-danger"></span>
                            </div>
                            <div class="form-group col">
                                <label class="control-label">Giá nhập</label>
                                <input asp-for="@Model.Prices[@i].PurchasePrice" class="form-control" />
                                <span asp-validation-for="@Model.Prices[@i].PurchasePrice" class="text-danger"></span>
                            </div>
                            <div class="form-group col">
                                <label class="control-label">Giá bán lẻ</label>
                                <input asp-for="@Model.Prices[@i].RetailPrice" class="form-control" />
                                <span asp-validation-for="@Model.Prices[@i].RetailPrice" class="text-danger"></span>
                            </div>
                            <div class="form-group col">
                                <label class="control-label">Giá bán sỉ</label>
                                <input asp-for="@Model.Prices[@i].WholesalePrice" class="form-control" />
                                <span asp-validation-for="@Model.Prices[@i].WholesalePrice" class="text-danger"></span>
                            </div>
                            <div class="form-group col d-flex align-items-center justify-content-center">
                                <button type="button" @(i==0 ? "disabled":"") class="btnRemove btn btn-sm btn-danger w-100" >Xóa</button>
                            </div>
                        </div>
                    }
                }
            </div>
            <div class="row">
                <div class="col-md-12 mt-3">
                    <button type="button" id="btnAddPrice" class="btn btn-outline-primary w-100">+ Thêm đơn vị tính</button>
                </div>
            </div>
        </div>
    </div>
</form>



@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(function () {
            $("#btnAddPrice").click(function () {
                let count = $("#price-container > .row").length;
            
                $("#price-container").append(`
                    <div class="row mt-3">
                        <div class="form-group col">
                            <label class="control-label">Đơn vị tính</label>
                            <input name="Prices[${count}].Unit" class="form-control" />
                        </div>
                        <div class="form-group col">
                            <label class="control-label">Quy đổi</label>
                            <input name="Prices[${count}].ConversionRate" class="form-control" />
                        </div>
                        <div class="form-group col">
                            <label class="control-label">Giá nhập</label>
                            <input name="Prices[${count}].PurchasePrice" class="form-control" />
                        </div>
                        <div class="form-group col">
                            <label class="control-label">Giá bán lẻ</label>
                            <input name="Prices[${count}].RetailPrice" class="form-control" />
                        </div>
                        <div class="form-group col">
                            <label class="control-label">Giá bán sỉ</label>
                            <input name="Prices[${count}].WholesalePrice" class="form-control" />
                        </div>
                        <div class="form-group col d-flex align-items-center justify-content-center">
                            <button type="button" class="btnRemove btn btn-sm btn-danger w-100">Xóa</button>
                        </div>
                    </div>
                `);

                AddRemoveAction();
            });

                
            AddRemoveAction();

            function ReAssignIndexPrices() {
                $("#price-container > .row").each(function(index, item) {
                    $(item).find(".form-control").each((y, item)=> {
                        $(item).attr("name", (i, currVal) => {
                            return currVal.replace(/\[\d+\]/, `[${index}]`);
                        })
                    })
                })
            }

            //add remove button click event
            function AddRemoveAction(){ 
                $(".btnRemove").each(function(index, item){
                    $(item).click(function(){
                        $(this).closest('.row').remove();
                        ReAssignIndexPrices()
                    });
                })
            }
        });
    </script>
}
